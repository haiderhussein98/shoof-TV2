scripts:
  - name: Flutter clean & get
    script: |
      set -e
      flutter --version
      flutter clean
      flutter pub get
      flutter precache --ios

  - name: Ensure Info.plist & Podfile (force iOS 13 / disable bitcode)
    script: |
      set -e
      PLIST="ios/Runner/Info.plist"
      /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier ${BUNDLE_ID}" "$PLIST"
      /usr/libexec/PlistBuddy -c "Set :CFBundleName ${APP_NAME}" "$PLIST" || \
      /usr/libexec/PlistBuddy -c "Add :CFBundleName string ${APP_NAME}" "$PLIST"
      /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName ${APP_NAME}" "$PLIST" || \
      /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string ${APP_NAME}" "$PLIST"

      # Podfile نظيف مع iOS 13 وإيقاف Bitcode
      cat > ios/Podfile <<'EOF'
      platform :ios, '13.0'
      ENV['COCOAPODS_DISABLE_STATS'] = 'true'

      def flutter_root
        generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
        unless File.exist?(generated_xcode_build_settings_path)
          raise "Generated.xcconfig must exist. Run 'flutter pub get' and try again."
        end
        File.foreach(generated_xcode_build_settings_path) do |line|
          matches = line.match(/FLUTTER_ROOT\=(.*)/)
          return matches[1].strip if matches
        end
        raise "FLUTTER_ROOT not found."
      end

      require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)
      flutter_ios_podfile_setup

      target 'Runner' do
        flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
      end

      post_install do |installer|
        installer.pods_project.targets.each do |t|
          t.build_configurations.each do |config|
            config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
            config.build_settings['ENABLE_BITCODE'] = 'NO'
          end
        end
      end
      EOF

  - name: Pod install (fresh)
    script: |
      set -e
      cd ios
      rm -rf Pods Podfile.lock
      pod repo update
      pod install --verbose
      cd ..

  # الأهم: بناء IPA عبر Flutter ليُرتّب Runner.app و Frameworks كما يتوقع iOS/Flutter
  - name: Flutter build ipa (no code sign)
    script: |
      set -e
      flutter build ipa --release --no-codesign
      ls -lah build/ios/ipa

  # تحقّق من وجود flutter_assets داخل الـ IPA وانسخه كمخرجات
  - name: Verify & export unsigned IPA
    script: |
      set -e
      IPA="build/ios/ipa/Runner.ipa"
      if [ ! -f "$IPA" ]; then
        echo "❌ Runner.ipa not found at $IPA"
        ls -R build || true
        exit 1
      fi
      # تأكيد وجود أصول Flutter داخل الـ IPA
      unzip -l "$IPA" | grep -q "App.framework/flutter_assets/AssetManifest.bin" \
        || { echo "❌ flutter_assets missing inside IPA"; exit 1; }
      cp "$IPA" "$CM_ARTIFACTS/shoof_tv-unsigned.ipa"
      echo "✅ Created $CM_ARTIFACTS/shoof_tv-unsigned.ipa"
